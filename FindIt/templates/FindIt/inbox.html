{% extends 'base.html' %}
{% block content %}
{% if active_conversation %}
<div class="d-flex justify-content-center" style="min-height:90vh;margin-top: 40px;">
  <div class="messaging-app d-flex shadow-lg" style="height:80vh; max-width:1200px; width:100%; border-radius: 10px; overflow: hidden;">
  <!-- Sidebar: Conversation List -->
  <aside class="sidebar bg-white border-end shadow-sm" style="width:320px;overflow-y:auto;">
    <div class="sidebar-header fw-bold p-3 border-bottom">My messages</div>
    <ul class="list-unstyled m-0">
      {% for convo in conversations %}
      <a href="{% url 'inbox' %}?item_id={{ convo.item_id }}&recipient_id={{ convo.other_user_id }}" style="text-decoration:none; color:inherit;">
        <li class="conversation p-3 d-flex align-items-center conversation-hover {% if convo.id == active_conversation.id %}bg-success-subtle active-convo{% endif %}" style="cursor:pointer; border-radius: 12px; margin-bottom: 6px;">
          <img src="{{ convo.avatar_url|default:'https://via.placeholder.com/40' }}" class="rounded-circle me-3 border border-2 border-success" width="44" height="44" alt="">
          <div class="flex-grow-1">
            <div class="fw-bold">{{ convo.name }}</div>
            <div class="small text-muted">{{ convo.last_message|truncatewords:6 }}</div>
          </div>
          <div class="text-end small text-muted ms-2">{{ convo.last_date|date:'M d' }}</div>
        </li>
      </a>
      {% endfor %}
    </ul>
  </aside>

  <!-- Chat Area -->
  <main class="chat-area flex-grow-1 d-flex flex-column shadow-sm" style="background: #fff;">
  <header class="chat-header d-flex align-items-center justify-content-between p-4 border-bottom bg-white shadow-sm" style="border-radius: 0 18px 0 0;">
      <div class="d-flex align-items-center">
  <img src="{{ active_conversation.item_image|default:'https://via.placeholder.com/48' }}" class="rounded me-3 border border-2 border-success" width="54" height="54" alt="">
        <div>
          <div class="fw-bold">{{ active_conversation.item_title }}</div>
          <div class="text-success fw-bold">{{ active_conversation.item_price }}</div>
        </div>
      </div>
      <!--<button class="btn btn-success">Show contact</button>-->
    </header>
  <section class="chat-history flex-grow-1 p-4" style="overflow-y:auto; background: linear-gradient(120deg, #f9f9f9 60%, #e6f4ea 100%);">
      <div class="text-center text-secondary small mb-3">{{ active_conversation.date|date:'F d, Y' }}</div>
      {% for msg in active_conversation.messages %}
        <div class="d-flex mb-3 {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
          <div class="chat-bubble p-3 shadow-sm {% if msg.sender == user %}sent{% else %}received{% endif %}" style="max-width:60%;">
            <div class="mb-1">{{ msg.content }}</div>
            <div class="small text-muted text-end">{{ msg.timestamp|time:'H:i' }}</div>
          </div>
        </div>
      {% endfor %}
    </section>
    <footer class="chat-footer p-3 border-top bg-white position-relative" style="border-radius: 0 0 18px 0;">
      <form method="post" class="d-flex mt-2">
        {% csrf_token %}
        <input type="hidden" name="item_id" value="{{ item_id }}">
        <input type="hidden" name="recipient_id" value="{{ recipient_id }}">
        <input type="text" name="message" class="form-control me-2 shadow-sm" placeholder="Write your message here">
        <button type="submit" class="btn btn-success shadow-sm">Send</button>
      </form>
    </footer>
  </main>
  </div>
</div>
{% else %}
<!-- Make sure Font Awesome is included in your project -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="d-flex justify-content-center align-items-center" style="min-height:60vh; background: #f8fafc;">
  <div class="card shadow-lg border-0 text-center p-4" style="max-width: 450px; border-radius: 20px;">
    <div class="mb-3">
      <i class="fa-solid fa-comments text-primary" style="font-size: 60px;"></i>
    </div>
    <h4 class="fw-bold text-primary">No Active Conversation</h4>
    <p class="text-muted mb-3">Looks like you donâ€™t have any active message conversations right now.</p>
  </div>
</div>


<!--<div class="d-flex justify-content-center align-items-center" style="min-height:60vh;">
  <div class="alert alert-info">No Active Conversation selected. Click <strong>Send In-site Message</strong> on an item to start a chat.</div>
</div> -->

{% endif %}
<style>
.messaging-app { font-family: 'Segoe UI', Arial, sans-serif; }
.sidebar-header { font-size: 1.2rem; letter-spacing: 0.5px; }
.conversation.bg-success-subtle, .active-convo { background: #e6f4ea !important; }
.conversation-hover:hover { background: #f0fdf4 !important; box-shadow: 0 2px 8px rgba(0,128,0,0.07); }
.chat-header { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.chat-history { background: linear-gradient(120deg, #f9f9f9 60%, #e6f4ea 100%); }
.chat-bubble { border-radius: 18px; min-width: 60px; word-break: break-word; }
.chat-bubble.sent { background: linear-gradient(135deg, #e6f4ea 80%, #b9fbc0 100%); color: #222; border-bottom-right-radius: 6px; }
.chat-bubble.received { background: #fff; border: 1px solid #e0e0e0; color: #222; border-bottom-left-radius: 6px; }
.chat-footer .btn { border-radius: 20px; }
.chat-footer input.form-control { border-radius: 20px; }
.chat-footer { box-shadow: 0 -2px 8px rgba(0,0,0,0.04); }
.quick-replies button { min-width: 120px; }
</style>
{% endblock %}
