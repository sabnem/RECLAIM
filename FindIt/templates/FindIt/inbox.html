{% extends 'base.html' %}
{% load static %}
{% block title %}Inbox{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/inbox.css' %}">

<style>
/* Hide navbar in inbox on mobile for full-screen messaging experience */
@media (max-width: 991px) {
    .navbar {
        display: none !important;
    }
}
</style>

<div class="messaging-container">
  <div class="container">
    <div class="messaging-app d-flex">

      <!-- Sidebar: Conversation List -->
      <aside class="sidebar" id="conversationList">
        <div class="sidebar-header d-flex align-items-center justify-content-between">
          <div>
            <i class="bi bi-chat-dots-fill me-2"></i>
            {% if request.GET.archived %}Archived Messages{% else %}Messages{% endif %}
          </div>
          <div class="d-flex align-items-center">
            <button class="btn btn-link text-white p-1 me-2" id="toggleArchivedBtn" title="{% if request.GET.archived %}Show Active Messages{% else %}Show Archived Messages{% endif %}">
              <i class="bi bi-{% if request.GET.archived %}chat-dots{% else %}archive{% endif %} fs-6"></i>
            </button>
            <button class="btn btn-link text-white d-md-none p-0" id="backToChatBtn" style="display:none !important;">
              <i class="bi bi-arrow-left fs-4"></i>
            </button>
          </div>
        </div>
        <div class="p-2">
          {% for convo in conversations %}
          <a href="{% url 'inbox' %}?item_id={{ convo.item_id }}&recipient_id={{ convo.other_user_id }}" style="text-decoration:none; color:inherit;">
            <div class="conversation d-flex align-items-center {% if active_conversation and convo.id == active_conversation.id %}active-convo{% endif %}">
              <img src="{% if convo.avatar_url %}{{ convo.avatar_url }}{% else %}https://ui-avatars.com/api/?name={{ convo.name|urlencode }}&background=D97706&color=fff&size=50{% endif %}" 
                   class="rounded-circle me-3 conversation-avatar" 
                   width="50" height="50" alt="Avatar">
              <div class="flex-grow-1">
                <div class="fw-bold mb-1" style="color: var(--text-primary);">{{ convo.name }}</div>
                <div class="small" style="color: var(--text-secondary);">
                  {{ convo.last_message|truncatewords:5 }}
                </div>
              </div>
              <div class="text-end small ms-2" style="color: var(--primary, #D97706);">
                {{ convo.last_date|date:'M d' }}
              </div>
            </div>
          </a>
          {% empty %}
          <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;">
            <div class="empty-state text-center">
              <div class="empty-icon-wrapper mb-4">
                <i class="bi bi-chat-left-dots-fill"></i>
              </div>
              <h3 class="fw-bold mb-3">No Messages Yet</h3>
              <p class="mb-4 empty-description">
                Start a conversation by contacting the owner or finder of an item.
              </p>
              <a href="{% url 'item_list' %}" class="btn-browse-items">
                Browse Items
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
      </aside>

      {% if active_conversation %}
      <!-- Chat Area -->
      <main class="chat-area flex-grow-1 d-flex flex-column" id="chatArea">
        <!-- Chat Header -->
        <header class="chat-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <button class="btn btn-link text-white p-0 me-3 d-md-none" id="backToListBtn">
              <i class="bi bi-arrow-left fs-4"></i>
            </button>
            <img src="{{ active_conversation.item_image|default:'https://via.placeholder.com/60' }}" 
                 class="rounded me-3 chat-header-avatar" 
                 width="60" height="60" alt="Item">
            <div>
              <div class="fw-bold text-white fs-5">{{ active_conversation.item_title }}</div>
              <div class="text-white opacity-75">
                <i class="bi bi-person-circle me-1"></i>
                {{ active_conversation.name }}
              </div>
            </div>
          </div>
          <div class="dropdown">
            <button class="btn btn-link text-white p-0" type="button" id="chatOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots-vertical fs-4"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatOptionsDropdown">
              {% if request.GET.archived %}
              <li>
                <a class="dropdown-item text-success" href="#" id="unarchiveConversationBtn">
                  <i class="bi bi-arrow-counterclockwise me-2"></i>
                  Unarchive Conversation
                </a>
              </li>
              {% else %}
              <li>
                <a class="dropdown-item text-warning" href="#" id="archiveConversationBtn">
                  <i class="bi bi-archive me-2"></i>
                  Archive Conversation
                </a>
              </li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li>
                <a class="dropdown-item text-danger" href="#" id="clearConversationBtn">
                  <i class="bi bi-trash me-2"></i>
                  Delete Conversation
                </a>
              </li>
            </ul>
          </div>
        </header>

        <!-- Chat History -->
        <section class="chat-history flex-grow-1" id="chatHistory">
          <div class="date-divider">
            <span>{{ active_conversation.date|date:'F d, Y' }}</span>
          </div>
          
          {% for msg in active_conversation.messages %}
          <div class="d-flex mb-3 {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
            <div class="chat-bubble {% if msg.sender == user %}sent{% else %}received{% endif %}">
              {% if msg.image %}
              <div class="mb-2">
                <img src="{{ msg.image.url }}" 
                     class="img-fluid" 
                     alt="Chat Image"
                     onclick="openLightbox('{{ msg.image.url }}')">
              </div>
              {% endif %}
              {% if msg.content %}
              <div class="mb-1">{{ msg.content }}</div>
              {% endif %}
              <div class="small opacity-75 text-end mt-1">
                {{ msg.timestamp|time:'H:i' }}
              </div>
            </div>
          </div>
          {% endfor %}
        </section>

        <!-- Chat Footer -->
        <footer class="chat-footer">
          <form method="post" enctype="multipart/form-data" id="chatForm">
            {% csrf_token %}
            <input type="hidden" name="item_id" value="{{ item_id }}">
            <input type="hidden" name="recipient_id" value="{{ recipient_id }}">
            
            <!-- Image Preview -->
            <div id="imagePreviewContainer" style="display: none;" class="mb-3">
              <div class="image-preview-wrapper">
                <img id="chatImagePreview" src="" alt="Preview" class="image-preview">
                <button type="button" id="removeImageBtn" class="remove-image-btn">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>

            <!-- Input Row -->
            <div class="d-flex align-items-center gap-2">
              <label for="chatImageUpload" class="btn-attach mb-0">
                <i class="bi bi-paperclip fs-5"></i>
              </label>
              <input type="file" 
                     id="chatImageUpload" 
                     name="chat_image" 
                     accept="image/*" 
                     style="display:none;">
              
              <input type="text" 
                     name="message" 
                     class="form-control message-input flex-grow-1" 
                     placeholder="Type your message..."
                     autocomplete="off">

              <button type="submit" class="btn btn-send" title="Send message">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </form>
        </footer>
      </main>
      {% endif %}

    </div>
  </div>
</div>

<!-- Lightbox -->
<div id="imageLightbox" onclick="closeLightbox()">
  <img id="lightboxImg" src="" alt="Full Image">
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Mobile navigation handling
  const conversationList = document.getElementById('conversationList');
  const chatArea = document.getElementById('chatArea');
  const backToListBtn = document.getElementById('backToListBtn');
  
  // Check if mobile
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  // Initialize mobile view
  function initMobileView() {
    if (isMobile()) {
      {% if active_conversation %}
        // If there's an active conversation, show chat area full screen
        if (conversationList) conversationList.style.display = 'none';
        if (chatArea) {
          chatArea.style.display = 'flex';
          chatArea.style.position = 'fixed';
          chatArea.style.top = '0';
          chatArea.style.left = '0';
          chatArea.style.width = '100vw';
          chatArea.style.height = '100vh';
          chatArea.style.zIndex = '1';
        }
      {% else %}
        // If no active conversation, show conversation list full screen
        if (conversationList) {
          conversationList.style.display = 'block';
          conversationList.style.position = 'fixed';
          conversationList.style.top = '0';
          conversationList.style.left = '0';
          conversationList.style.width = '100vw';
          conversationList.style.height = '100vh';
          conversationList.style.zIndex = '2';
        }
        if (chatArea) chatArea.style.display = 'none';
      {% endif %}
    } else {
      // Desktop: reset to normal layout
      if (conversationList) {
        conversationList.style.display = 'block';
        conversationList.style.position = 'relative';
        conversationList.style.width = '340px';
        conversationList.style.height = 'auto';
      }
      if (chatArea) {
        chatArea.style.display = 'flex';
        chatArea.style.position = 'relative';
        chatArea.style.width = 'auto';
        chatArea.style.height = '75vh'; // Reduced from 85vh to account for navbar
      }
    }
  }
  
  // Initialize on load
  initMobileView();
  
  // Back to conversation list
  if (backToListBtn) {
    backToListBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (isMobile()) {
        // Hide chat area and show conversation list
        if (chatArea) chatArea.style.display = 'none';
        if (conversationList) {
          conversationList.style.display = 'block';
          conversationList.style.position = 'fixed';
          conversationList.style.top = '0';
          conversationList.style.left = '0';
          conversationList.style.width = '100vw';
          conversationList.style.height = '100vh';
          conversationList.style.zIndex = '2';
        }
        // Navigate to inbox list view
        window.location.href = '{% url "inbox" %}?view=list';
      }
    });
  }
  
  // Handle window resize
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      initMobileView();
    }, 250);
  });

  // Scroll chat to bottom
  let chatHistory = document.getElementById("chatHistory");
  if (chatHistory) chatHistory.scrollTop = chatHistory.scrollHeight;

  // WebSocket Setup for Real-Time Messaging
  {% if active_conversation %}
  const conversationId = '{{ active_conversation.id }}';
  const currentUserId = {{ user.id }};
  const recipientId = {{ recipient_id|default:"null" }};
  const itemId = {{ item_id|default:"null" }};
  
  console.log('WebSocket Debug Info:', {
    conversationId: conversationId,
    currentUserId: currentUserId,
    recipientId: recipientId,
    itemId: itemId
  });
  
  // WebSocket connection
  const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  const wsUrl = protocol + window.location.host + '/ws/chat/' + conversationId + '/';
  console.log('Connecting to WebSocket:', wsUrl);
  const chatSocket = new WebSocket(wsUrl);

  chatSocket.onopen = function(e) {
    console.log('âœ… WebSocket connection established');
  };

  chatSocket.onmessage = function(e) {
    console.log('ðŸ“¨ Received message:', e.data);
    const data = JSON.parse(e.data);
    
    // Only add message if it's not from current user (to avoid duplicates)
    if (data.sender_id != currentUserId) {
      console.log('Adding message from other user');
      appendMessage(data);
    } else {
      console.log('Skipping own message (already displayed)');
    }
  };

  chatSocket.onclose = function(e) {
    console.error('âŒ WebSocket closed unexpectedly', e);
  };

  chatSocket.onerror = function(e) {
    console.error('âŒ WebSocket error:', e);
  };

  // Function to append message to chat
  function appendMessage(data) {
    const chatHistory = document.getElementById('chatHistory');
    const isCurrentUser = data.sender_id == currentUserId;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `d-flex mb-3 ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = `chat-bubble ${isCurrentUser ? 'sent' : 'received'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'mb-1';
    contentDiv.textContent = data.message;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'small opacity-75 text-end mt-1';
    const now = new Date();
    timeDiv.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    
    bubbleDiv.appendChild(contentDiv);
    bubbleDiv.appendChild(timeDiv);
    messageDiv.appendChild(bubbleDiv);
    chatHistory.appendChild(messageDiv);
    
    // Scroll to bottom
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  // Handle form submission
  const chatForm = document.getElementById('chatForm');
  const messageInput = chatForm.querySelector('input[name="message"]');
  
  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    console.log('ðŸ“¤ Sending message via WebSocket:', message);
    
    // Send message via WebSocket
    const messageData = {
      'message': message,
      'sender_id': currentUserId,
      'recipient_id': recipientId,
      'item_id': itemId,
      'image': null
    };
    
    console.log('Message data:', messageData);
    chatSocket.send(JSON.stringify(messageData));
    
    // Add message to chat immediately for current user
    appendMessage({
      'message': message,
      'sender_id': currentUserId,
      'timestamp': new Date().toISOString()
    });
    
    // Clear input
    messageInput.value = '';
  });
  {% endif %}

  // Image upload preview
  const fileInput = document.getElementById("chatImageUpload");
  const previewContainer = document.getElementById("imagePreviewContainer");
  const previewImg = document.getElementById("chatImagePreview");
  const removeBtn = document.getElementById("removeImageBtn");

  if (fileInput) {
    fileInput.addEventListener("change", function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          previewContainer.style.display = "block";
        };
        reader.readAsDataURL(this.files[0]);
      }
    });
  }

  if (removeBtn) {
    removeBtn.addEventListener("click", function() {
      fileInput.value = "";
      previewImg.src = "";
      previewContainer.style.display = "none";
    });
  }

  // Archive conversation functionality
  const archiveConversationBtn = document.getElementById('archiveConversationBtn');
  if (archiveConversationBtn) {
    archiveConversationBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (confirm('Archive this conversation? Messages will be hidden from your inbox but preserved for reference.')) {
        // Send request to backend to archive messages
        fetch('{% url "clear_conversation" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            action: 'archive',
            item_id: {{ item_id|default:"null" }},
            recipient_id: {{ recipient_id|default:"null" }}
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message
            alert('âœ… Conversation archived successfully! Messages are preserved for reference.');
            
            // Redirect to inbox home
            window.location.href = '{% url "inbox" %}?view=list';
          } else {
            alert('Failed to archive conversation: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while archiving the conversation.');
        });
      }
    });
  }

  // Unarchive conversation functionality
  const unarchiveConversationBtn = document.getElementById('unarchiveConversationBtn');
  if (unarchiveConversationBtn) {
    unarchiveConversationBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (confirm('Unarchive this conversation? Messages will be restored to your inbox.')) {
        // Send request to backend to unarchive messages
        fetch('{% url "clear_conversation" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            action: 'unarchive',
            item_id: {{ item_id|default:"null" }},
            recipient_id: {{ recipient_id|default:"null" }}
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message
            alert('âœ… Conversation unarchived successfully! Messages are now visible in your inbox.');
            
            // Redirect to active inbox
            window.location.href = '{% url "inbox" %}?view=list';
          } else {
            alert('Failed to unarchive conversation: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while unarchiving the conversation.');
        });
      }
    });
  }

  // Delete conversation functionality
  const clearConversationBtn = document.getElementById('clearConversationBtn');
  if (clearConversationBtn) {
    clearConversationBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (confirm('Are you sure you want to delete this conversation? This action cannot be undone and all messages will be permanently removed.')) {
        // Send request to backend to delete messages
        fetch('{% url "clear_conversation" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            action: 'delete',
            item_id: {{ item_id|default:"null" }},
            recipient_id: {{ recipient_id|default:"null" }}
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message
            alert('âœ… Conversation deleted successfully! All messages have been permanently removed.');
            
            // Redirect to inbox home
            window.location.href = '{% url "inbox" %}?view=list';
          } else {
            alert('Failed to delete conversation: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while deleting the conversation.');
        });
      }
    });
  }

  // Toggle between active and archived conversations
  const toggleArchivedBtn = document.getElementById('toggleArchivedBtn');
  if (toggleArchivedBtn) {
    toggleArchivedBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const currentUrl = new URL(window.location);
      const isArchived = currentUrl.searchParams.get('archived') === '1';
      
      if (isArchived) {
        // Switch to active conversations
        currentUrl.searchParams.delete('archived');
        currentUrl.searchParams.set('view', 'list');
      } else {
        // Switch to archived conversations
        currentUrl.searchParams.set('archived', '1');
        currentUrl.searchParams.delete('view');
        currentUrl.searchParams.delete('item_id');
        currentUrl.searchParams.delete('recipient_id');
      }
      
      window.location.href = currentUrl.toString();
    });
  }

});

// Lightbox functions
function openLightbox(src) {
  const lightbox = document.getElementById('imageLightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  lightboxImg.src = src;
  lightbox.style.display = 'flex';
}

function closeLightbox() {
  const lightbox = document.getElementById('imageLightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  lightbox.style.display = 'none';
  lightboxImg.src = '';
}
</script>

{% endblock %}
