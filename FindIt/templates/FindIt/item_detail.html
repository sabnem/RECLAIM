{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-lg border-0 bg-white rounded-4">
      {% if item.photo %}
      {% comment %} full item display regardless of aspect ratio {% endcomment %}
          <div style="width:100%; max-width:400px; height:300px; margin:auto; background:#f8f9fa; display:flex; align-items:center; justify-content:center; border-radius:0.5rem;">
            <img src="{{ item.photo.url }}" style="max-width:100%; max-height:100%; object-fit:contain; display:block;" alt="Item photo">
          </div>
      {% endif %}
      <div class="card-body p-5">
        <h2 class="card-title fw-bold mb-3">{{ item.title }}</h2>
        <span class="badge {% if item.status == 'lost' %}bg-danger{% else %}bg-success{% endif %} me-1">{{ item.get_status_display }}</span>
        <span class="badge bg-secondary me-1">{{ item.category }}</span>
        {% if item.is_returned %}
          <span class="badge bg-info text-dark me-1"><i class="bi bi-check-circle"></i> Returned</span>
        {% endif %}
        <div class="mt-3"><strong>Description:</strong> {{ item.description }}</div>
        <div><strong>Location:</strong> <i class="bi bi-geo-alt"></i> {{ item.location }}</div>
        <div><strong>Reported by:</strong> <i class="bi bi-person"></i> {{ item.reported_by.username }}</div>
        <div><strong>Date Reported:</strong> <i class="bi bi-calendar-event"></i> {{ item.date_reported|date:'Y-m-d H:i' }}</div>
          {% if user.is_authenticated and user == item.reported_by %}
                <button type="button" class="btn btn-info text-white" id="editItemBtn" style="display:inline; margin-top: 12px;">
                  <i class="bi bi-pencil-square"></i> Edit Item
                </button>
                <form method="post" action="{% url 'edit_item_fields' item.id %}" enctype="multipart/form-data" class="mb-3" id="editItemForm" style="display:none;">
                  {% csrf_token %}
                  <div class="mb-2">
                    <label for="itemPhoto" class="form-label">Change Image</label>
                    <input type="file" class="form-control" id="itemPhoto" name="photo">
                  </div>
                  <div class="mb-2">
                    <label for="itemDescription" class="form-label">Edit Description</label>
                    <textarea class="form-control" id="itemDescription" name="description" rows="2">{{ item.description }}</textarea>
                  </div>
                  <div class="mb-2">
                    <label for="itemLocation" class="form-label">Edit Location</label>
                    <input type="text" class="form-control" id="itemLocation" name="location" value="{{ item.location }}">
                  </div>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    var editBtn = document.getElementById('editItemBtn');
                    var editForm = document.getElementById('editItemForm');
                    if (editBtn && editForm) {
                      editBtn.addEventListener('click', function() {
                        editForm.style.display = (editForm.style.display === 'none') ? 'block' : 'none';
                      });
                    }
                  });
                </script>
          {% endif %}
        <div class="d-flex flex-wrap gap-2 mt-4">
            <!-- Safety Tips Modal Trigger -->
            <a href="{% url 'terms_and_conditions' %}" class="btn btn-outline-info mb-2" target="_blank">
              <i class="bi bi-shield-check"></i> Safety & Terms
            </a>
          {% if user.is_authenticated and user != item.reported_by %}
            <a href="{% url 'inbox' %}?item_id={{ item.id }}&recipient_id={{ item.reported_by.id }}" class="btn btn-warning"><i class="bi bi-chat-dots"></i> Send In-site Message</a>
          {% endif %}
          {% if user.is_authenticated and user == item.reported_by %}
            <form method="post" action="{% url 'mark_item_returned' item.id %}" style="display:inline;" id="markReturnedForm">
              {% csrf_token %}
              {% if item.is_returned %}
                <button type="submit" class="btn btn-outline-info"><i class="bi bi-x-circle"></i> Mark as Not Returned</button>
              {% else %}
                <button type="button" class="btn btn-info text-white" id="markReturnedBtn"><i class="bi bi-check-circle"></i> Mark as Returned</button>
              {% endif %}
            </form>

            <!-- Modal for entering owner's username -->
            <div class="modal fade" id="ownerModal" tabindex="-1" aria-labelledby="ownerModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="ownerModalLabel">Enter Owner's Username</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <input type="text" class="form-control" id="ownerUsername" name="owner_username" placeholder="Owner's Username" required autocomplete="off">
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitOwnerBtn">Submit</button>
                  </div>
                </div>
              </div>
            </div>

            <script>
              document.addEventListener('DOMContentLoaded', function() {
                var markReturnedBtn = document.getElementById('markReturnedBtn');
                var ownerModalEl = document.getElementById('ownerModal');
                var ownerModal = ownerModalEl ? new bootstrap.Modal(ownerModalEl) : null;
                var markReturnedForm = document.getElementById('markReturnedForm');
                var ownerUsernameInput = document.getElementById('ownerUsername');
                var submitOwnerBtn = document.getElementById('submitOwnerBtn');

                if (markReturnedBtn && ownerModal) {
                  markReturnedBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    ownerUsernameInput.value = '';
                    ownerModal.show();
                    setTimeout(function() {
                      ownerUsernameInput.focus();
                    }, 300);
                  });
                }

                if (submitOwnerBtn && ownerModal) {
                  submitOwnerBtn.addEventListener('click', function() {
                    var username = ownerUsernameInput.value.trim();
                    if (!username) {
                      ownerUsernameInput.focus();
                      return;
                    }
                    // Remove any previous hidden input to avoid duplicates
                    var oldInput = markReturnedForm.querySelector('input[name="owner_username"]');
                    if (oldInput) oldInput.remove();
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'owner_username';
                    input.value = username;
                    markReturnedForm.appendChild(input);
                    // Submit only after modal finishes hiding
                    ownerModalEl.addEventListener('hidden.bs.modal', function onHidden() {
                      markReturnedForm.submit();
                      ownerModalEl.removeEventListener('hidden.bs.modal', onHidden);
                    });
                    ownerModal.hide();
                  });
                }
              });
            </script>
          {% elif user.is_authenticated and item.owner and user == item.owner and item.is_returned and confirmation and not confirmation.owner_confirmed %}
            <form method="post" action="{% url 'mark_item_returned' item.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-info text-white"><i class="bi bi-check-circle"></i> Confirm Return</button>
            </form>
          {% elif user.is_authenticated and user.is_superuser %}
            <form method="post" action="{% url 'mark_item_returned' item.id %}" style="display:inline;">
              {% csrf_token %}
              {% if item.is_returned %}
                <button type="submit" class="btn btn-outline-info"><i class="bi bi-x-circle"></i> Mark as Not Returned</button>
              {% else %}
                <button type="submit" class="btn btn-info text-white"><i class="bi bi-check-circle"></i> Mark as Returned</button>
              {% endif %}
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
